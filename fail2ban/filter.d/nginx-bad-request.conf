# Fail2Ban filter to match bad requests to nginx
#

[Definition]

# Match only actual bad requests, not protocol-specific responses
failregex = ^<HOST> - \S+ \[\] "(?:GET|POST|PUT|DELETE|HEAD|OPTIONS|TRACE|CONNECT) [^"]*" 400
            ^<HOST> - \S+ \[\] "-" 400
            ^<HOST> - \S+ \[\] ".*" 400

# Ignore gRPC/h2 specific patterns
ignoreregex = ^<HOST> - \S+ \[\] "POST /${NGINX_PATH}/[^"]* HTTP/2\.0" 400
             ^<HOST> - \S+ \[\] "POST /${NGINX_PATH}/[^"]* HTTP/1\.1" 400
             ^<HOST> - \S+ \[\] "POST /${NGINX_PATH}/[^"]* HTTP/3\.0" 400
             ^<HOST> - \S+ \[\] "POST /${NGINX_PATH}/[^"]*?x_padding=[^"]* HTTP/2\.0" 400
             ^<HOST> - \S+ \[\] "POST /${NGINX_PATH}/[^"]*?x_padding=[^"]* HTTP/1\.1" 400
             ^<HOST> - \S+ \[\] "POST /${NGINX_PATH}/[^"]*?x_padding=[^"]* HTTP/3\.0" 400

datepattern = {^LN-BEG}%%ExY(?P<_sep>[-/.])%%m(?P=_sep)%%d[T ]%%H:%%M:%%S(?:[.,]%%f)?(?:\s*%%z)?
              ^[^\[]*\[({DATE})
              {^LN-BEG}

journalmatch = _SYSTEMD_UNIT=nginx.service + _COMM=nginx
